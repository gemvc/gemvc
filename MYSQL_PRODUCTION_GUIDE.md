# MySQL Production Configuration Guide

## ‚ö†Ô∏è Important: Development vs Production

The MySQL configuration generated by `gemvc init` is **optimized for DEVELOPMENT ONLY**.

For **PRODUCTION** deployments, your DevOps team must make critical changes.

---

## üî¥ Critical Changes Required for Production

### 1. **Data Durability (CRITICAL)**

**Development Setting:**
```yaml
--innodb-flush-log-at-trx-commit=2
```

**Production Setting:**
```yaml
--innodb-flush-log-at-trx-commit=1
```

**Why?** 
- `=2`: Fast but can lose up to 1 second of transactions on crash
- `=1`: Full ACID compliance, every transaction persisted to disk
- **Impact**: Essential for financial data, orders, payments, critical records

---

### 2. **Binary Logging (CRITICAL)**

**Development Setting:**
```yaml
--skip-log-bin  # Binary logging disabled
```

**Production Setting:**
```yaml
# Remove --skip-log-bin and add:
--log-bin=mysql-bin
--binlog-format=ROW
--expire-logs-days=7
--sync-binlog=1
```

**Why?**
- Enables point-in-time recovery
- Required for replication
- Essential for disaster recovery
- Allows rollback to any point in time

---

### 3. **Authentication & Security (CRITICAL)**

**Development Setting:**
```yaml
MYSQL_ROOT_PASSWORD: "rootpassword"
```

**Production Setting:**
```yaml
MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"  # Use secrets/vault
MYSQL_DATABASE: "${DB_NAME}"
MYSQL_USER: "${DB_USER}"
MYSQL_PASSWORD: "${DB_PASSWORD}"
```

**Additional Security:**
```yaml
command:
  # Enable SSL for production
  - --require-secure-transport=ON
  - --ssl-ca=/etc/mysql/certs/ca.pem
  - --ssl-cert=/etc/mysql/certs/server-cert.pem
  - --ssl-key=/etc/mysql/certs/server-key.pem
```

---

### 4. **Resource Allocation**

**Development Setting:**
```yaml
mem_limit: 2g
mem_reservation: 1g
cpus: 2
--innodb-buffer-pool-size=1G
```

**Production Setting (Example for 8GB RAM server):**
```yaml
mem_limit: 8g
mem_reservation: 4g
cpus: 4
--innodb-buffer-pool-size=5G      # 50-70% of available RAM
--innodb-buffer-pool-instances=8  # For better concurrency
```

---

## üìä Recommended Production Configuration

### Full Example (for 8GB RAM, production-ready):

```yaml
db:
  image: mysql:8.0
  
  # Resource limits
  mem_limit: 8g
  mem_reservation: 4g
  cpus: 4
  
  command:
    # Character set
    - --character-set-server=utf8mb4
    - --collation-server=utf8mb4_unicode_ci
    - --authentication-policy=caching_sha2_password
    
    # Network optimization
    - --host-cache-size=256
    - --skip-name-resolve
    - --max-connections=500
    - --thread-cache-size=100
    
    # PRODUCTION: Full ACID compliance
    - --innodb-flush-log-at-trx-commit=1
    - --sync-binlog=1
    
    # PRODUCTION: Binary logging for backups
    - --log-bin=mysql-bin
    - --binlog-format=ROW
    - --expire-logs-days=7
    
    # PRODUCTION: SSL/TLS
    - --require-secure-transport=ON
    - --ssl-ca=/etc/mysql/certs/ca.pem
    - --ssl-cert=/etc/mysql/certs/server-cert.pem
    - --ssl-key=/etc/mysql/certs/server-key.pem
    
    # InnoDB optimization for production
    - --innodb-buffer-pool-size=5G
    - --innodb-buffer-pool-instances=8
    - --innodb-log-file-size=512M
    - --innodb-log-buffer-size=64M
    - --innodb-flush-method=O_DIRECT
    - --innodb-file-per-table=1
    - --innodb-read-io-threads=8
    - --innodb-write-io-threads=8
    
    # Query cache and buffers
    - --table-open-cache=4000
    - --table-definition-cache=2000
    - --sort-buffer-size=2M
    - --join-buffer-size=2M
    - --read-buffer-size=1M
    - --read-rnd-buffer-size=2M
    
    # Temporary tables
    - --tmp-table-size=128M
    - --max-heap-table-size=128M
    
    # Network
    - --max-allowed-packet=128M
    - --net-buffer-length=32768
    
    # Logging (adjust verbosity as needed)
    - --log-error=/var/log/mysql/error.log
    - --log-error-verbosity=2
    - --slow-query-log=1
    - --slow-query-log-file=/var/log/mysql/slow.log
    - --long-query-time=2
  
  ports:
    - "3306:3306"
  
  volumes:
    - mysql-data:/var/lib/mysql
    - mysql-logs:/var/log/mysql
    - mysql-certs:/etc/mysql/certs:ro
  
  environment:
    MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
    MYSQL_DATABASE: "${MYSQL_DATABASE}"
    MYSQL_USER: "${MYSQL_USER}"
    MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
  
  networks:
    - backend-network
  
  # Health check
  healthcheck:
    test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
    interval: 10s
    timeout: 5s
    retries: 5
  
  # Restart policy
  restart: unless-stopped
  
  # Security options
  security_opt:
    - no-new-privileges:true
```

---

## üéØ Production Deployment Checklist

### Before Going Live:

- [ ] Change `innodb-flush-log-at-trx-commit` to `1`
- [ ] Enable binary logging (remove `skip-log-bin`)
- [ ] Configure SSL/TLS certificates
- [ ] Use secrets management (Docker Secrets, Vault, AWS Secrets Manager)
- [ ] Set strong passwords (min 16 chars, mixed case, symbols)
- [ ] Configure automated backups
- [ ] Set up monitoring (Prometheus, Datadog, New Relic)
- [ ] Configure log rotation
- [ ] Test disaster recovery procedures
- [ ] Document backup/restore procedures
- [ ] Set up alerting for critical metrics
- [ ] Review and adjust connection limits
- [ ] Configure firewall rules
- [ ] Enable audit logging if required
- [ ] Set up replication if needed

### Monitoring Metrics:

- CPU usage
- Memory usage
- Connection count
- Slow query count
- InnoDB buffer pool hit ratio
- Disk I/O
- Replication lag (if applicable)

---

## üèóÔ∏è Alternative Production Architectures

### Managed Database Services (Recommended)

Instead of self-hosting MySQL in Docker, consider:

- **AWS RDS for MySQL** - Fully managed, automated backups, easy scaling
- **Azure Database for MySQL** - Managed service with HA options
- **Google Cloud SQL** - Managed MySQL with automatic failover
- **PlanetScale** - Serverless MySQL with branching
- **DigitalOcean Managed Databases** - Simple, cost-effective

**Benefits:**
- Automated backups and point-in-time recovery
- Automatic security patches
- Built-in monitoring and alerting
- High availability and failover
- Scaling without downtime
- Professional DBA support

### High Availability Setup

For self-hosted production:

```
Master-Slave Replication:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  Master  ‚îÇ (Writes)
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ        ‚îÇ
‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê
‚îÇSlave‚îÇ  ‚îÇSlave‚îÇ (Reads)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Or use orchestration:
- **MySQL Group Replication**
- **Galera Cluster**
- **ProxySQL** for connection pooling and load balancing

---

## üìö Additional Resources

- [MySQL 8.0 Production Checklist](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)
- [InnoDB Configuration Best Practices](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html)
- [MySQL Security Guide](https://dev.mysql.com/doc/refman/8.0/en/security.html)
- [Backup and Recovery](https://dev.mysql.com/doc/refman/8.0/en/backup-and-recovery.html)

---

## üí° Development vs Production Summary

| Setting | Development | Production | Reason |
|---------|-------------|------------|--------|
| Durability | `=2` | `=1` | ACID compliance |
| Binary Log | Disabled | Enabled | Point-in-time recovery |
| Password | Default | Secret | Security |
| SSL | Disabled | Enabled | Encryption |
| Memory | 2GB | 8GB+ | Performance |
| Monitoring | Basic | Full | Operations |
| Backups | Manual | Automated | Data safety |
| HA | Single | Replicated | Availability |

---

**Remember**: The development config prioritizes **speed and ease of use**. Production prioritizes **data safety, security, and reliability**.

**Contact your DevOps/SRE team** before deploying to production!

